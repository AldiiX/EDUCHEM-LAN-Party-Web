name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: test:latest
          load: true

      - name: Deploy to server
        run: |
          echo "Vol√°n√≠ deploy endpointu..."

          # volani api
          curl -s -w "\n%{http_code}" -o response.json \
            -X POST "https://deploy.emsio.cz/ghad/df/v1/run" \
            -H "X-GHAD-Token: ${{ secrets.DEPLOY_TOKEN }}" \
            -H "X-GHRP-Uuid: ${{ secrets.PROJECT_UUID }}" \
            -H "X-GHRP-Name: ${{ github.repository }}" > result.txt

          http_code=$(tail -n1 result.txt)
          body=$(head -n -1 result.txt)

          echo "Server odpovƒõƒè: $body"
          echo "Status code: $http_code"

          # vypis do step summary
          echo "### üöÄ Deploy v√Ωstup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP status:** \`$http_code\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$body" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # pokud status neni 200, ukoncit jako error
          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Chyba: server vr√°til $http_code"
            exit 1
          fi
